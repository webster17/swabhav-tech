<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>MCQ - Test</title>
    <link rel="stylesheet" href="http://localhost/jquery-app/js-to-jquery/resources/bootstrap4/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://localhost/jquery-app/js-to-jquery/resources/font-awesome/css/font-awesome.min.css">
</head>

<body>
    <div class="container">
        <div class="row mt-3 justify-content-center rounded bg-light align-center">
            <div class="col"></div>
            <div class="col-xl-12 text-center rounded vertical-center">
                <h3> Question Bank -
                    <kbd>MCQ Test</kbd>
                </h3>
            </div>
            <div class="col"></div>
        </div>
        <div class="row mt-3 justify-content-center rounded align-center text-success d-none" id="result">
            <h3>You Scored: 30%</h3>
        </div>
        <div class="row mt-3">
            <div class="col-md-10 m-0 p-0 mx-auto col-xs-12">
                <form class="was-validated" action="javascript:void(0)" novalidate>
                    <div class="row mb-2">
                        <div class="form-group w-100">
                            <div id="question-list">
                            </div>
                            <div class="form-row">
                                <div class="col-sm-12 col-md-7 mx-auto text-center d-none status"></div>
                                <div class="col-md-7 col-sm-12 mx-auto">
                                    <button class="btn bg-dark btn-block text-light" id="test-action" data="start-test">Start Test</button>
                                </div>
                            </div>
                        </div>
                        <div class="d-none" id="question-clone-element">
                            <div class="form-row border-top">
                                <label class="col-sm-12 mt-2" class="question"></label>
                                <div class="option-list mb-3">
                                </div>
                            </div>
                        </div>
                        <div class="d-none" id="option-clone-element">
                            <div class="col-sm-11 ml-5  custom-control custom-radio">
                                <input type="radio" class="custom-control-input" id="" name="" required>
                                <label class="custom-control-label" for=""></label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="http://localhost/jquery-app/js-to-jquery/resources/jquery.min.js"></script>
    <script src="http://localhost/jquery-app/js-to-jquery/resources/bootstrap4/js/bootstrap.min.js"></script>
    <script>
        "use strict";

        (function () {

            var questionListElement = $('#question-list');
            var testActionButtonElement = $('#test-action');
            var questionCloneElement = $('#question-clone-element div');
            var optionCloneElement = $('#option-clone-element div');
            var resultElement = $('#result');
            var submit = $('#submit');
            var action = $('#action');
            var questionBankObj = {};
            var sequence;
            var scoreCounter = 0;



            function generateRandomSequence(end) {
                var random = Math.round((Math.random() * 100000) % (end - 1));
                if (sequence.length != end) {
                    var exist = 0;
                    for (var i in sequence) {
                        if (sequence[i] == random) {
                            exist = 1;
                        }
                    }
                    if (exist == 0) {
                        sequence.push(random);
                    }
                    generateRandomSequence(end);
                }
            }

            function displayOptionsList(qtId, questionNode, options) {
                var optionsList = $(questionNode).find('div');
                for (var key in options) {
                    var option = $(optionCloneElement);
                    $(option).find('label').html(options[key]).attr('for', 'option'+qtId+key);
                    $(option).find('input').attr('id', 'option'+qtId+key).attr('name', 'question'+qtId).val(key);
                    $(optionCloneElement).clone().appendTo(optionsList);
                }
                
                $(questionListElement).append(questionNode);
            }

            function displayQuestionBank(questionBankObj) {
                for (var i in sequence) {
                    var questionNode = $(questionCloneElement).clone();
                    $(questionNode).find('label').html(questionBankObj[sequence[i]].question);
                    displayOptionsList(sequence[i], questionNode, questionBankObj[sequence[i]].options);
                }
            }

            function startAttempt() {
                $.ajax({
                    method: 'GET',
                    url: 'http://localhost/jquery-app/js-to-jquery/assignment/resources/question-bank.json',
                    dataType: 'json',
                    beforeSend: function () {
                        scoreCounter = 0;
                        $(resultElement).addClass('d-none');
                        $(testActionButtonElement).html("<i class='fa fa-spinner fa-spin'></i> Loading...").attr('disabled', 'disabled');
                        $(questionListElement).html('');
                    },
                    success: function (response) {
                        questionBankObj = response;
                        sequence = [];
                        generateRandomSequence(questionBankObj.length);
                        displayQuestionBank(questionBankObj);
                        $(testActionButtonElement).attr('data', 'submit-test').html("Submit Test");
                    },
                    error: function (request, status, error) {
                        $(testActionButtonElement).text("Retry");
                    },
                    complete: function () {
                        $(testActionButtonElement).removeAttr("disabled");
                    }
                });
            }

            $(testActionButtonElement).on('click', function () {
                if ($(this).attr('data') == 'start-test')
                    startAttempt();
                else if ($(this).attr('data') == 'submit-test')
                    submitAttempt();
            });


            function getRadioVal(form, name) {
                var val;

                var radios = form.elements[name];

                for (var i = 0, len = radios.length; i < len; i++) {
                    if (radios[i].checked) {
                        val = radios[i].value;
                        break;
                    }
                }
                return val;
            }

            function showResult(percentage) {
                console.log('here');

                action.setAttribute('style', 'display:none');
                questionListElement.innerHTML = "";

                var scoreNode = document.createElement('h3');
                var scoreTextNode = document.createTextNode("You have scored: " + percentage + "%");
                scoreNode.appendChild(scoreTextNode);

                var restratButtonNode = document.createElement('BUTTON');
                var restratButtonTextNode = document.createTextNode("Restart Test");
                restratButtonNode.appendChild(restratButtonTextNode);
                restratButtonNode.setAttribute('id', 'start');
                restratButtonNode.addEventListener('click', startAttempt);

                questionListElement.appendChild(scoreNode);
                questionListElement.appendChild(restratButtonNode);
            }

            function calculatePercentage(functionShowResult) {
                for (var i in sequence) {
                    var selectedOption = $('input[name=question'+sequence[i]+']:checked').val();
                    
                    if (selectedOption != undefined) {
                        if (questionBankObj[sequence[i]].answer == selectedOption) {
                            scoreCounter++;
                        }
                    }
                }

                var percentage = (scoreCounter * 100) / questionBankObj.length;
                
                $(questionListElement).html("");
                $(testActionButtonElement).attr('data', 'start-test').html("Restart Test");
                $(resultElement).removeClass('d-none');
                $(resultElement).find('h3').html('You have scored '+percentage+'%');
            }

            function submitAttempt() {
                calculatePercentage(showResult);
            }


        })();
    </script>
</body>

</html>